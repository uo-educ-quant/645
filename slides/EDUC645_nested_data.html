<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Introduction to Nested Data</title>
    <meta charset="utf-8" />
    <meta name="author" content="TBD" />
    <script src="EDUC645_nested_data_files/header-attrs-2.14/header-attrs.js"></script>
    <link href="EDUC645_nested_data_files/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="EDUC645_nested_data_files/remark-css-0.0.1/uo.css" rel="stylesheet" />
    <link href="EDUC645_nested_data_files/remark-css-0.0.1/ki-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="my_custom.css" type="text/css" />
    <link rel="stylesheet" href="xaringanthemer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Introduction to Nested Data
]
.subtitle[
## EDUC 645: General Linear Model II
]
.author[
### TBD
]

---




# Roadmap

---
# Goals for the unit
- Introduce nested data structure (two-level, e.g., repeated measures within individuals, students within schools)
- Understand and explain what nesting/clustering means
- Demonstrate varying intercepts and slopes across clusters. 
- Practice fitting the same regression model independently for each cluster and create a table of intercepts and slopes across clusters
- Understand what it means for intercepts and slopes to vary across clusters
- Discuss the notion that regression coefficients may vary across different clusters
- Develop the concept of:
  - fixed-effects as the aggregation of the different intercepts and slopes by taking an average of varying intercept and slopes across clusters
	- random effects as the difference between cluster-specific intercept and slope and their averages across clusters
	- covariance matrix of random-effects
- Discuss the implications of ignoring the variance of random-effects in terms of the inference for fixed-effects and statistical power

- Introduce 
	- Random intercept-only model
	  - its estimation through the R lmer package, 
		- interpret the model parameters and align them with the earlier discussion of fixed-effects and random-effects.
	- Intra-class correlation as a measure of within-cluster dependency
and how to use it to decide whether one needs to use multilevel modeling

---
# What is Nested Data?

---
# Where does it come from?
### Why do we need to think hierarchically?
1) Two realities exist within interventions:
  (a) Effect implies change in individuals over time,
  (b) Effect occurs in groups and organizational settings (e.g., dyads, groups, networks, neighborhoods, clinics, cities, countries).

--

2) Factors are nested across multiple levels; influence the organization of behavior.

---
# What happens if we ignore it?

### What errors result if we ignore multilevel effects?
#### Ecological Fallacy
- Systematic underestimation of group effects
- Inadequate intervention development and evaluation
#### Aggregation bias
- Attribute that an individual-level indicator is representative of the entire group
#### Biased estimation of statistical associations
- Misestimated standard errors
- Homogeneity of regression slopes

---
# Traditional Linear Regression Example
* Unit of analysis: Individual
* Examine between-individual variability
* Intercept and slope are the same for all groups
* Ignores inclusion of important group variables
* Residual correlation

---
# What does “independence” mean?
#### The observation of one participant does not depend on the response of other participants

#### What happens to independence when:
- We collect data across multiple sites?
- Collect observations from the same individual over time?

---
# Intraclass Correlation
### Intraclass correlation: Proportion of total variability in the outcome that occurs between groups.

--

### The greater the intraclass correlation coefficient (ICC), the greater the reflection of inequality between groups.


---
# Intraclass Correlation
### How have we commonly taken care of the ICC “issue”?
- Ecologic Regression
- Stratified Regressions
- Group fixed-effects Model
- Contextual Model
- Hierarchical Linear Models

--

### Group-level modeling

--

### Repeated-measured modeling (“Growth curves”)

---
# Multilevel Models (MLM)

* Units of analysis: Individual and Group
* Examine between-individual and between-group variability
* The intercept and slopes may be different for individuals within and across groups
* These differences may be explained by cross-level interactions (differential effects due to individual and group-level characteristics)
* Allows for the inclusion of important individual and group variables
* No residual correlation

---
# Sampling and Design Considerations

### Formulating Research Questions

#### Several questions may be proposed and result in different multilevel equations:
- What is the association between UVI and number of partners among women in PR, after adjusting for clustering effects?
- Is there an association between UVI and living in a city where female condoms (FCs) are free and accessible?
- Do characteristics pertaining to a city modify the association between UVI and number of partners?

---
# Sampling and Design Considerations
### Design
#### What constitutes a group-level variable?
- Characteristic of
  - individual (provider, partner)
  - a setting (number of beds in hospital, allocated budget for HIV prevention in an agency)
  - catchment areas (Census, DHS)
- Policies (% of budget allocated to abstinence-only)

--

#### How are group-level variables defined?
- Aggregating individual-level characteristics into groups
(neighborhood SES)
- Developing group-level measures (AIDS stigma in a
neighborhood)

---
# Sampling and Design Considerations
### Sampling
#### Calculating Statistical Power is similar to “traditional” analyses
- Formulate the hypotheses to be tested
- Compute or Estimate the ICC
- Determine the variable and outcome of interest
- Determine the sample frame based on the I.V.(s)

--

#### Sampling clusters or sampling individuals?
- Determine the number of parameters in the model
- Calculate the number of observations needed for each cluster

--

#### Law of Diminishing Returns

---
# Nested and crossed random effects in "lme4"

Load the packages particularly needed for this unit: `lme4`, `equatiomatic`, `performance`, `lmerTest`

---
# 3.1.1 Inspect the data 

What does each row/observation represent?


```
## 'data.frame':	352 obs. of  8 variables:
##  $ district    : chr  "VALE SD 84" "VALE SD 84" "VALE SD 84" "VALE SD 84" ...
##  $ subject     : chr  "Math" "Reading" "Math" "Reading" ...
##  $ grade       : int  3 3 4 4 5 5 6 6 3 3 ...
##  $ achievement : num  2.54 3.23 3.09 4.36 4.57 ...
##  $ gap_gender  : num  0.974 0.376 -0.788 -1.83 0.836 ...
##  $ percent_ell : num  0.0492 0.0492 0.0492 0.0492 0.0492 ...
##  $ percent_sped: num  0.128 0.128 0.128 0.128 0.128 ...
##  $ percent_frl : num  0.622 0.622 0.622 0.622 0.622 ...
```

```
##     district subject grade achievement gap_gender percent_ell percent_sped
## 1 VALE SD 84    Math     3    2.539072  0.9736566  0.04923414    0.1280088
## 2 VALE SD 84 Reading     3    3.229844  0.3761424  0.04923414    0.1280088
## 3 VALE SD 84    Math     4    3.089542 -0.7882404  0.04923414    0.1280088
## 4 VALE SD 84 Reading     4    4.362786 -1.8302576  0.04923414    0.1280088
## 5 VALE SD 84    Math     5    4.574462  0.8356159  0.04923414    0.1280088
## 6 VALE SD 84 Reading     5    4.778020  0.3570311  0.04923414    0.1280088
##   percent_frl
## 1   0.6216102
## 2   0.6216102
## 3   0.6216102
## 4   0.6216102
## 5   0.6216102
## 6   0.6216102
```

<div id="zmelfygifl" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#zmelfygifl .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zmelfygifl .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zmelfygifl .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zmelfygifl .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zmelfygifl .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zmelfygifl .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zmelfygifl .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#zmelfygifl .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zmelfygifl .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zmelfygifl .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zmelfygifl .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zmelfygifl .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#zmelfygifl .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zmelfygifl .gt_from_md > :first-child {
  margin-top: 0;
}

#zmelfygifl .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zmelfygifl .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zmelfygifl .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#zmelfygifl .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#zmelfygifl .gt_row_group_first td {
  border-top-width: 2px;
}

#zmelfygifl .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmelfygifl .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#zmelfygifl .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#zmelfygifl .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zmelfygifl .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmelfygifl .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zmelfygifl .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zmelfygifl .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zmelfygifl .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zmelfygifl .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmelfygifl .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zmelfygifl .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmelfygifl .gt_left {
  text-align: left;
}

#zmelfygifl .gt_center {
  text-align: center;
}

#zmelfygifl .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zmelfygifl .gt_font_normal {
  font-weight: normal;
}

#zmelfygifl .gt_font_bold {
  font-weight: bold;
}

#zmelfygifl .gt_font_italic {
  font-style: italic;
}

#zmelfygifl .gt_super {
  font-size: 65%;
}

#zmelfygifl .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

#zmelfygifl .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#zmelfygifl .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#zmelfygifl .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

#zmelfygifl .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

#zmelfygifl .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1"><strong>Key Variables</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1"><strong>N = 352</strong><sup class="gt_footnote_marks">1</sup></th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_left">Subject</td>
<td class="gt_row gt_center"></td></tr>
    <tr><td class="gt_row gt_left" style="text-align: left; text-indent: 10px;">Math</td>
<td class="gt_row gt_center">176 / 352 (50%)</td></tr>
    <tr><td class="gt_row gt_left" style="text-align: left; text-indent: 10px;">Reading</td>
<td class="gt_row gt_center">176 / 352 (50%)</td></tr>
    <tr><td class="gt_row gt_left">Grade</td>
<td class="gt_row gt_center"></td></tr>
    <tr><td class="gt_row gt_left" style="text-align: left; text-indent: 10px;">3</td>
<td class="gt_row gt_center">88 / 352 (25%)</td></tr>
    <tr><td class="gt_row gt_left" style="text-align: left; text-indent: 10px;">4</td>
<td class="gt_row gt_center">88 / 352 (25%)</td></tr>
    <tr><td class="gt_row gt_left" style="text-align: left; text-indent: 10px;">5</td>
<td class="gt_row gt_center">88 / 352 (25%)</td></tr>
    <tr><td class="gt_row gt_left" style="text-align: left; text-indent: 10px;">6</td>
<td class="gt_row gt_center">88 / 352 (25%)</td></tr>
    <tr><td class="gt_row gt_left">Achievement</td>
<td class="gt_row gt_center">4.06 (1.67)</td></tr>
    <tr><td class="gt_row gt_left">Achievement Gender Gap</td>
<td class="gt_row gt_center">-0.41 (0.79)</td></tr>
    <tr><td class="gt_row gt_left">ELL Percentage</td>
<td class="gt_row gt_center">0.09 (0.08)</td></tr>
    <tr><td class="gt_row gt_left">SPED Percentage</td>
<td class="gt_row gt_center">0.148 (0.023)</td></tr>
    <tr><td class="gt_row gt_left">FRL Percentage</td>
<td class="gt_row gt_center">0.55 (0.17)</td></tr>
  </tbody>
  
  <tfoot class="gt_footnotes">
    <tr>
      <td class="gt_footnote" colspan="2"><sup class="gt_footnote_marks">1</sup> n / N (%); Mean (SD)</td>
    </tr>
  </tfoot>
</table>
</div>

---
# 3.1.2 Understand the clustering nature

For starters, look at a single variable - Oregon districts' achievement score 

(note that districts are "randomly" selected by course developer)

Are we losing information by simply looking at district achievement across subject and grade?

![add caption](EDUC645_nested_data_files/figure-html/unnamed-chunk-2-1.png)

---

Does achievement differ by subject?

![add caption](EDUC645_nested_data_files/figure-html/unnamed-chunk-3-1.png)

---

Differ by grade?

![add caption](EDUC645_nested_data_files/figure-html/unnamed-chunk-4-1.png)

---

Differ by grade AND subject?

![add caption](EDUC645_nested_data_files/figure-html/unnamed-chunk-5-1.png)

---

Alternatively, 

![add caption](EDUC645_nested_data_files/figure-html/unnamed-chunk-6-1.png)

Can you describe the "clustering" nature of the data in more details now?

IMPORTANTLY, should we keep in mind of this unique feature when we answering research questions, e.g., about relations between two variables?

---
# Relationship across grade and subject:

For example, let's look at relationship between percentage of ELL and achievement


```
## `geom_smooth()` using formula 'y ~ x'
```

![add caption](EDUC645_nested_data_files/figure-html/unnamed-chunk-7-1.png)

---

Does this relationship differ by subject?


```
## `geom_smooth()` using formula 'y ~ x'
```

![add caption](EDUC645_nested_data_files/figure-html/unnamed-chunk-8-1.png)

---

Does this relationship differ by subject AND grade?


```
## `geom_smooth()` using formula 'y ~ x'
```

![add caption](EDUC645_nested_data_files/figure-html/unnamed-chunk-9-1.png)

What is your current understanding of clustered data? Is there a single answer to the relationship between percentage of ELL students and achievement? 

(expect students to realize that there is no universal answer; depends on what you look at, what cluster/clusters you want to include, and model specifications)

---

# 3.1.3 Modeling the relationship between two variables

**For this introductory course, we only focus on two-level clustered data.**

From now on, we pull out the cluster of subject, and focus on math achievement only.

**Overarching inquiry: What is the relationship between percentage of ELL students and math achievement in Oregon districts?**

What model/models can we fit to answer the question? 



---

# Fixed effects model

.pull-left[
One way to answer the question is assuming a common intercept for all grades. 

--

Model specifications (using multiple regression knowledge you learned from EDUC 643, you can do it!):

]

Visually:
.pull-right[

```
## `geom_smooth()` using formula 'y ~ x'
```

![add caption](EDUC645_nested_data_files/figure-html/unnamed-chunk-11-1.png)
]

---

How to interpret these parameters?

.pull-left[

```r
m1 &lt;- lm(math ~ percent_ell, district)
summary(m1)
```

```
## 
## Call:
## lm(formula = math ~ percent_ell, data = district)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.3177 -1.2300  0.0205  1.0922  3.8539 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   4.5048     0.1794  25.107  &lt; 2e-16 ***
## percent_ell  -6.4669     1.5726  -4.112 6.03e-05 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 1.577 on 174 degrees of freedom
## Multiple R-squared:  0.08858,	Adjusted R-squared:  0.08334 
## F-statistic: 16.91 on 1 and 174 DF,  p-value: 6.03e-05
```
]

.pull-right[

```r
coef(m1)
```

```
## (Intercept) percent_ell 
##    4.504827   -6.466889
```
]

---

# Random effects model

Another way to answer the question is allowing the intercept to differ across grades - a unique intercept for each grade.

Visually:


```r
district %&gt;% 
  ggplot(aes(percent_ell, math, color = grade)) +
  geom_smooth(method='lm', se = 0) +
  geom_point(alpha = 0.1) + 
  labs(x = "ELL Percentage",
       y = "Math")
```

```
## `geom_smooth()` using formula 'y ~ x'
```

![](EDUC645_nested_data_files/figure-html/unnamed-chunk-14-1.png)&lt;!-- --&gt;

What parameters changed in the plot? 

 - the intercept: each grade has a unique intercept

 - the slope: the slope also changes accordingly

**In fact, mixed-effects models can do more!** 

let's take advantage of the lme4 package, lmer function to quickly model the data in R:

 - Model 1. Put the simple linear regression model here for comparison
 

```r
m1 &lt;- lm(math ~ percent_ell, district)

coef(m1)
```

```
## (Intercept) percent_ell 
##    4.504827   -6.466889
```

 - Model 2. Multilevel model with random intercepts 
 
      - What parameter differs across grades? what parameter remains the same?
      - Interpret the parameters

*R notes: starting the basics of the lme4::lmer() syntax*


```r
m2 &lt;- lme4::lmer(math ~ percent_ell + (1|grade), district)
summary(m2)
```

```
## Linear mixed model fit by REML ['lmerMod']
## Formula: math ~ percent_ell + (1 | grade)
##    Data: district
## 
## REML criterion at convergence: 495.2
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.4707 -0.6017 -0.1026  0.3954  3.2973 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  grade    (Intercept) 2.0855   1.4441  
##  Residual             0.9037   0.9506  
## Number of obs: 176, groups:  grade, 4
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)   4.5048     0.7301    6.17
## percent_ell  -6.4669     0.9482   -6.82
## 
## Correlation of Fixed Effects:
##             (Intr)
## percent_ell -0.111
```

```r
coef(m2)$grade
```

```
##    (Intercept) percent_ell
## G3    2.856961   -6.466889
## G4    3.913716   -6.466889
## G5    5.065668   -6.466889
## G6    6.182964   -6.466889
```

*R Notes: starting the usage of {equatiomatic} package*

The notion being used through this unit:


```r
equatiomatic::extract_eq(m2)
```

$$
`\begin{aligned}
  \operatorname{math}_{i}  &amp;\sim N \left(\alpha_{j[i]} + \beta_{1}(\operatorname{percent\_ell}), \sigma^2 \right) \\
    \alpha_{j}  &amp;\sim N \left(\mu_{\alpha_{j}}, \sigma^2_{\alpha_{j}} \right)
    \text{, for grade j = 1,} \dots \text{,J}
\end{aligned}`
$$

 - Model 3. Multilevel model with random slopes 
 
      - (note that this is a weird practice in real data analysis but here I just include it for comparison purposes)
 
      - How do you interpret the parameters now?
 

```r
m3 &lt;- lmer(math ~ 1 + (0 + percent_ell|grade), district)
summary(m3)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: math ~ 1 + (0 + percent_ell | grade)
##    Data: district
## 
## REML criterion at convergence: 602.2
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.54361 -0.67403 -0.05695  0.64832  2.86774 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  grade    percent_ell 103.371  10.167  
##  Residual               1.642   1.281  
## Number of obs: 176, groups:  grade, 4
## 
## Fixed effects:
##             Estimate Std. Error       df t value Pr(&gt;|t|)    
## (Intercept)   4.4720     0.1434 174.0856    31.2   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

```r
coef(m3)$grade
```

```
##    percent_ell (Intercept)
## G3  -16.307389     4.47197
## G4  -10.263599     4.47197
## G5   -2.428400     4.47197
## G6    4.669357     4.47197
```

```r
# extract_eq(m3) doesn't work here
```
    
 - Model 4. Multilevel model with random intercepts and slopes 
 
      - How about the parameters for this model specification?
      - Can you specify the relationship between percentage of ELL and math achievement for grade 3? grade 4? .. grade 6?


```r
m4 &lt;- lmer(math ~ percent_ell + (1 + percent_ell|grade), district)
summary(m4)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: math ~ percent_ell + (1 + percent_ell | grade)
##    Data: district
## 
## REML criterion at convergence: 495.2
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.5018 -0.6141 -0.1065  0.4072  3.3055 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr 
##  grade    (Intercept) 2.16293  1.4707        
##           percent_ell 0.09197  0.3033   -1.00
##  Residual             0.90329  0.9504        
## Number of obs: 176, groups:  grade, 4
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)   4.5048     0.7433  2.9972   6.061  0.00904 ** 
## percent_ell  -6.4669     0.9600 45.4216  -6.736  2.4e-08 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Correlation of Fixed Effects:
##             (Intr)
## percent_ell -0.264
```

```r
coef(m4)$grade
```

```
##    (Intercept) percent_ell
## G3    2.826638   -6.120839
## G4    3.904292   -6.343056
## G5    5.075495   -6.584562
## G6    6.212885   -6.819096
```

```r
extract_eq(m4)
```

$$
`\begin{aligned}
  \operatorname{math}_{i}  &amp;\sim N \left(\alpha_{j[i]} + \beta_{1j[i]}(\operatorname{percent\_ell}), \sigma^2 \right) \\    
\left(
  \begin{array}{c} 
    \begin{aligned}
      &amp;\alpha_{j} \\
      &amp;\beta_{1j}
    \end{aligned}
  \end{array}
\right)
  &amp;\sim N \left(
\left(
  \begin{array}{c} 
    \begin{aligned}
      &amp;\mu_{\alpha_{j}} \\
      &amp;\mu_{\beta_{1j}}
    \end{aligned}
  \end{array}
\right)
, 
\left(
  \begin{array}{cc}
     \sigma^2_{\alpha_{j}} &amp; \rho_{\alpha_{j}\beta_{1j}} \\ 
     \rho_{\beta_{1j}\alpha_{j}} &amp; \sigma^2_{\beta_{1j}}
  \end{array}
\right)
 \right)
    \text{, for grade j = 1,} \dots \text{,J}
\end{aligned}`
$$

What did we learn so far? Describe the differences between model 1 (simple linear regression) and a model with
 - Random intercepts, model 2
 - Random slopes, model 3
 - Random intercepts and slopes, model 4

---
#3.1.4 Fixed effects vs random effects

If we put the two previous plots together, can you describe:
 - what does the bright red line represent? 
 - what do the other four lines represent? 


```
## `geom_smooth()` using formula 'y ~ x'
## `geom_smooth()` using formula 'y ~ x'
```

![add caption](EDUC645_nested_data_files/figure-html/unnamed-chunk-20-1.png)

---

Also a review of the relationship between fixed effect (model 1) and random effects (model 4) parameters:

Run the code for yourself and see what you notice:


```r
coef(m1)[1]
```

```
## (Intercept) 
##    4.504827
```

```r
mean(unlist(coef(m4)$grade[1]))
```

```
## [1] 4.504827
```

Run the code for yourself and see what you notice:


```r
coef(m1)[2]
```

```
## percent_ell 
##   -6.466889
```

```r
mean(unlist(coef(m4)$grade[2]))
```

```
## [1] -6.466889
```

What might be the reason behind these?

To sum up:

 - fixed effect represents the aggregation of the different intercepts and slopes by taking an average of varying intercept and slopes across clusters
 
 - random effects represent the difference between cluster-specific intercept and slope and their averages across clusters

---
# When modeling random effects becomes necessary?
## Unconditional model and ICC

We estimate a baseline model, model 0, to see how much variance in math is attributable to between-grade variation

*R notes: starting the {performance} package usage*


```r
m0 &lt;- lmer(math ~ 1 + (1 | grade), district)
extract_eq(m0)
```

$$
`\begin{aligned}
  \operatorname{math}_{i}  &amp;\sim N \left(\alpha_{j[i]}, \sigma^2 \right) \\
    \alpha_{j}  &amp;\sim N \left(\mu_{\alpha_{j}}, \sigma^2_{\alpha_{j}} \right)
    \text{, for grade j = 1,} \dots \text{,J}
\end{aligned}`
$$

```r
summary(m0)
```

```
## Linear mixed model fit by REML. t-tests use Satterthwaite's method [
## lmerModLmerTest]
## Formula: math ~ 1 + (1 | grade)
##    Data: district
## 
## REML criterion at convergence: 538.4
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.1915 -0.6925 -0.1216  0.5393  3.3323 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  grade    (Intercept) 2.080    1.442   
##  Residual             1.143    1.069   
## Number of obs: 176, groups:  grade, 4
## 
## Fixed effects:
##             Estimate Std. Error     df t value Pr(&gt;|t|)  
## (Intercept)   3.9520     0.7256 3.0000   5.446   0.0122 *
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```

```r
performance::icc(m0)
```

```
## # Intraclass Correlation Coefficient
## 
##     Adjusted ICC: 0.645
##   Unadjusted ICC: 0.645
```

---
#ICC: intraclass correlation coefficient

Specifically, about 64.5% of the variance in math achievement lies between grades. 

At this point, the fixed effects model aggregating grade-level achievement to a grand mean is masking important information regarding grade-level achievement.
 
allow you to investigate changes over time

--- 
# Model fit 
So far, we have one fixed effects model (simple linear regression, model 1) and four random effects (more accurately, mixed-effects) models including the unconditional model (model 0), random intercepts (model 2), random slopes (model 3), and random intercepts and slopes (model 4). 

How do we know which one is preferred?

--

(from Dr. Daniel Anderson's multilevel modeling II course)

  - RMSE
  - Chi squared significance test of the change in the model deviance
  - Information criteria (AIC/BIC)
  - Cross validation procedures

---

For example, comparing model 1 and model 4:


```r
performance::compare_performance(m1, m4) %&gt;% 
  print_md()
```



Table: Comparison of Model Performance Indices

|Name |           Model |    AIC | AIC weights |    BIC | BIC weights | RMSE | Sigma |   R2 | R2 (adj.) |   AICc | AICc weights | R2 (cond.) | R2 (marg.) |  ICC |
|:----|:---------------:|:------:|:-----------:|:------:|:-----------:|:----:|:-----:|:----:|:---------:|:------:|:------------:|:----------:|:----------:|:----:|
|m1   |              lm | 663.72 |    4.34e-34 | 673.23 |    5.04e-32 | 1.57 |  1.58 | 0.09 |      0.08 |        |              |            |            |      |
|m4   | lmerModLmerTest | 510.08 |        1.00 | 529.10 |        1.00 | 0.94 |  0.95 |      |           | 510.58 |              |       0.72 |       0.07 | 0.70 |



```r
test_likelihoodratio(m1, m4) %&gt;% 
  print_md
```



|Name |           Model| df| df_diff|   Chi2|        p|
|:----|---------------:|--:|-------:|------:|--------:|
|m1   |              lm|  3|        |       |         |
|m4   | lmerModLmerTest|  6|       3| 159.64| 2.19e-34|

Another example, comparing model 2 and model 4:


```r
performance::compare_performance(m2, m4) %&gt;% 
  print_md()
```



Table: Comparison of Model Performance Indices

|Name |           Model |    AIC | AIC weights |   AICc | AICc weights |    BIC | BIC weights | R2 (cond.) | R2 (marg.) |  ICC | RMSE | Sigma |
|:----|:---------------:|:------:|:-----------:|:------:|:------------:|:------:|:-----------:|:----------:|:----------:|:----:|:----:|:-----:|
|m2   |         lmerMod | 506.16 |       0.877 | 506.39 |        0.890 | 518.84 |       0.994 |       0.72 |       0.07 | 0.70 | 0.94 |  0.95 |
|m4   | lmerModLmerTest | 510.08 |       0.123 | 510.58 |        0.110 | 529.10 |       0.006 |       0.72 |       0.07 | 0.70 | 0.94 |  0.95 |



```r
test_likelihoodratio(m2, m4) %&gt;% 
  print_md
```



|Name |           Model| df| df_diff| Chi2|    p|
|:----|---------------:|--:|-------:|----:|----:|
|m2   |         lmerMod|  4|        |     |     |
|m4   | lmerModLmerTest|  6|       2| 0.08| 0.96|

--

Definitely prefer model 4 over model 1; 

But model 4 doesn't perform much better than model 2 (identical RMSE; insignificant chi squared test of the change in the model deviance; also visually confirmed in the previous random-intercept random-slope plot that the slope of the fitted line didn't vary too much across four grades), so for this little exercise, I would choose model 2 for parsimonious reason.

---
# Summary
### Multilevel Modeling allows us to answer complex questions adequately if:
- An appropriate study design is conceptualized
- Measures across levels are identified from existing datasets or carefully operationalized

### Multilevel Modeling may be appropriate if residual correlations exist due to violations of independence
- Benefit of partitioning variance even when Level-1 or Level-2 variables will not be modeled
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
