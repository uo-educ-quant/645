---
title: "Poisson Regression"
subtitle: "EDUC 645: General Linear Model II"
author: "TBD"
#date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  xaringan::moon_reader:
    css: ['default', 'uo', 'ki-fonts', 'my_custom.css', 'xaringanthemer.css']
    # self_contained: true
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
  editor_options: 
  chunk_output_type: console
---

```{R, setup, include = F}
library(pacman)
p_load(here, tidyverse, ggplot2, xaringan, knitr, kableExtra, foreign, broom, xaringanthemer)

i_am("slides/EDUC645_poisson_regression.rmd")

extra_css <- list(
  ".red"   = list(color = "red"),
  ".blue"  =list(color = "blue"),
  ".green" = list(color = "#8bb174"),
  ".purple" = list(color = "#6A5ACD"),
  ".red-pink" = list(color= "#e64173"),
  ".grey-light" = list(color= "grey70"),
  ".slate" = list(color="#314f4f"),
  ".small" = list("font-size" = "90%"))

write_extra_css(css = extra_css, outfile = "my_custom.css")

red_pink <- "#e64173"
turquoise = "#20B2AA"
orange = "#FFA500"
red = "#fb6107"
blue = "#3b3b9a"
green = "#8bb174"
grey_light = "grey70"
grey_mid = "grey50"
grey_dark = "grey20"
purple = "#6A5ACD"
slate = "#314f4f"
extra_css <- list(
  ".red"   = list(color = "red"),
  ".blue"  =list(color = "blue"),
  ".red-pink" = list(color= "red_pink"),
  ".grey-light" = list(color= "grey_light"),
  ".purple" = list(color = "purple"),
  ".small" = list("font-size" = "90%"))
write_extra_css(css = extra_css, outfile = "my_custom.css")



```

# Roadmap

---
# Count Data

What about examining predictors of outcomes related to a rate or number of events:
* the number of times an event occurs during a given timeframe?
* the number of people in line at the grocery store?

These kinds of questions draw from count data
* Discrete data with non-negative integer values that count a particular outcome according to a defined parameter of time/space

**How does this definition differ from binomial data?**

--

**How does this definition differ from continuous data?**

---

# Normal distribution vs. poisson distribution

.pull-left[
```{r, echo=F}
# create a sequence -3 to +3 with .05 increments
xseq <- seq(-3, 3, .05)

# generate a Probability Density Function
densities <- dnorm(xseq, 0, 1)

# plot the graph
plot(xseq, densities, col = "blue", xlab = "", ylab = "Density", type = "l", lwd = 2)
# col: changes the color of line
# 'xlab' and 'ylab' are labels for x and y axis respectively
# type: defines the type of plot. 'l' gives a line graph
# lwd: defines line width
```
]

--

.pull-right[
```{r, echo=F}
# create a sequence -3 to +3 with .05 increments
xseq <- seq(0, 20, 1)

# generate a Probability Density Function
densities <- dpois(xseq, lambda = 3)

# plot the graph
plot(xseq, densities, col = "blue", xlab = "", ylab = "Density", type = "l", lwd = 2)
# col: changes the color of line
# 'xlab' and 'ylab' are labels for x and y axis respectively
# type: defines the type of plot. 'l' gives a line graph
# lwd: defines line width
```
]


---

# Poisson Distribution

* A discrete probability distribution is used to describe the off occurrence of unlikely events in a large number of independent trials

* Poisson is a good approximation to the binomial distribution when the probability is small and the number of trials is large

* It expresses the probability of a number of events occurring in a fixed period of time if these events occur with a known average rate and are independent of the time since the last event
Examine if we want to know "how many of X in what amount of time"

---
# Poisson Distributions

```{r, echo=F, fig.height=5.5}
lambdas <- c(10, 20, 30, 40)

pois_plot <- ggplot(data = data.frame(x = 0:75)) +
    lapply(lambdas, 
           function(l) geom_point(aes(x = x, 
                                      y = dpois(x, lambda = l), 
                                      col = factor(l)))) +
    lapply(lambdas, 
           function(l) stat_function(fun = dnorm, 
                                     args = list(mean = l, sd = sqrt(l)), 
                                    aes(x = x, col = factor(l))))
pois_plot 
```

---

```{r, echo=F}
par(mfrow = c(3, 2), mar = c(1, 1, 2, 1), oma = c(4, 4, 2, 0))
for (i in c(1, 2, 3, 5, 7, 9)) {
    curve(dpois(x, lambda = i), from = 0, to = 18, n = 19, type = "p", pch = 15,
        cex = 1.5, xlim = c(0, 19), ylim = c(0, 0.4), xlab = "", ylab = "")
    text(x = 15, y = 0.3, substitute(lambda == x, list(x = i)), cex = 2)
}
mtext("Probability Mass Function for Poisson Distribution", line = 0.5,
    outer = TRUE, cex = 1.2)
mtext(expression(P(X == x)), side = 2, line = 1.5, outer = TRUE)
mtext("X", side = 1, line = 1.5, outer = TRUE)
```

---
# Poisson Vs. Normal Distribution

|Poisson Distribution |	Normal Distribution|
|----------------------------|---------------------------------|
|Used for count or rate data |	Used for continuous variables |
|Skewed by values of lambda	 | Bell-shaped curve symmetric around the mean.|
|Variance = Mean	| Variance and mean are different parameters; mean, median and mode are equal |

---
# Poisson Distribution: Dispersion


---
# Time

Time: normalizes the count variable that is observed
- Number of accidents per day, per year, per week
- Units of time, length of time, or other unit
Number of accidents per mile, students per district

---
# Rate

Rate = # of events/unit of time

Sometimes rescaled so that the number of cases per unit is a whole number
Rate $\neq$ probability

|       |Rate                 |Probability|
|-------|---------------------|-----------|
| Units |Include unit of time |Do not have a unit|
| Range of values |Can be >1            |Between 0 and 1|

---
# Comparing Rates

Suppose we want to compare rate of Y at two different sites (X groups) 
We have to assume that incidents occurred at similar rates throughout the year
Typically organize information about counts and time in a table:

|	       |Count|Time |
|--------|-----|-----|
|Group 1 | N1	 |T1   |
|Group 2 | N2	 |T2   |

---
# Steps to comparing rates:

### 1. Calculate rates in both groups
$$Rate = \frac{n_{events}}{unit_{time}}$$

### 2. Calculate Rate Ratio (RR)
$$RR = \frac{Rate_1}{Rate_2}$$

### 3. Conduct test of hypothesis to see is RR $\neq$ 1

$$H_0: RR = 1$$
$$H_a: RR \neq 1$$

$$z = \frac{ln(RR)}{\sqrt{(\frac{1}{n_1}+\frac{1}{n_2}}}$$
* Get $p$-value
* Get CI for RR
*	Draw conclusions
	
---

# [insert examples]

---
class: middle, inverse
# Modeling Poisson Distribution
.left[Poisson Regression]

---
# Poisson Regression V. Logistic Regression

- Like logistic regression, the underlying mathematics and underlying probability distribution theory are different from OLS regression
  - Relies on the same parameters of the GLM

* Logistic regression models the **log odds of _an event_**

* Poisson regression models the **natural log of _an expected count_**
  - Negative predicted values non-issue (negative values correspond to expected counts between 0 and 1)

---
# Poisson Regression 

* Helps us analyze both count data and rate data 
  - Can determine which explanatory variables (X values) have an effect on a given response variable (Y value, the count or a rate). 
  - For example, school districts could use to better predict the number of students who receive free/reduced lunch.

---
# Interpretation of Model Parameters

$$\log(\lambda) = \beta_0 + \beta_1X$$
$\lambda$: Average number of occurrences per unit of time or space, as a function of one or more covariates

$\beta_0$: log of the rate for the reference group

$\beta_1$: log of the rate ratio between a given group and the reference group

$X$:predictor variable

---
# Rates Accounting for other factor(s)
Poisson regression allows us to study how rates of an even vary by characteristics of the groups of interest
$$\ln(Rate) = \beta_0 + \beta_1X$$

- $E[Y]$: expected number of events

- $X$: predictor variable

- $\beta_0$: natural log of the rate for the reference group

- $\beta_1$: natural log of the rate ratio between a given group and the reference group
	- Similar to the logistic regression where the coefficient was the natural log of the OR

--

### alternatively written...

$$\ln(\frac{E[Y]}{Time}) = \beta_0 + \beta_1X$$

$$\ln(E[Y]) - \ln(Time) = \beta_0 + \beta_1X$$

$$\ln(E[Y]) = \beta_0 + \beta_1X + \ln(Time)$$

- $\ln(Time)$: *offset variable* takes into account the rate of change over time

---
# Interpreting Coefficients
Poisson regression coefficient represents the *change in response corresponding to a one unit difference in the corresponding predictor.* 

???
Like other regression coefficients, a Poisson regression coefficient represents the change in response corresponding to a one unit difference in the corresponding predictor. Here, the response is expected (natural) logged count.

---
# Assumptions

The outcome (Y) is a count (positive integer)
* Ex. the number of people in a subgroup of a population who have a learning disorder
Requires a unit of time:
* E.g., number of accidents per day, number of exposed per year

Count data can also be expressed as rate data
* the number of times an event occurs within a timeframe can be expressed as:
- raw count (i.e. “In a day, we eat three meals”)
- rate (“We eat at a rate of 0.125 meals per hour”)

* Response Variable: The response variable is a count per unit of time or space, described by a Poisson distribution.
* Independence: The observations must be independent of one another.
* Mean=Variance By definition, the mean of a Poisson random variable must be equal to its variance.
* Linearity: The log of the mean rate, log(λ), must be a linear function of x.

---
class: middle, inverse
# Synthesis and wrap-up

---
# Beyond the Poisson: Other fish in the sea
* Negative binomial
* Zero-inflated models

---
# OLS regression vs. Poisson regression

|                 | Linear Least Squares | Poisson Regression |
|-----------------|----------------------|--------------------|
|Response variable| Normal distribution  | Discrete counts    |
|Variance         | equal for each level of X | Equal to the mean for each level of X |
|Model fitting    | $\mu=\beta_0+\beta_1x$ with Least Squares | $\log(\lambda)=\beta_0+\beta_1x$ with Maximum Likelihood |
|EDA              | plot X vs. Y; add line | Find $\log(\bar{y})$ for several subgroups; plot vs. X|
|Comparing models | extra sum of squares F-tests; AIC/BIC | drop-in-deviance tests; AIC/BIC |
|Interpreting coef| $\beta_1$ = change in mean response for unit change in X | $e^{\beta_1}$= percent change in $\lambda$ for unit change in X|