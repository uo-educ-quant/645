---
title: "Poisson Regression"
subtitle: "EDUC 645: General Linear Model II"
author: "TBD"
#date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  xaringan::moon_reader:
    css: ['default', 'uo', 'ki-fonts', 'my_custom.css', 'xaringanthemer.css']
    # self_contained: true
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{R, setup, include = F}
library(pacman)
p_load(here, tidyverse, ggplot2, xaringan, knitr, kableExtra, foreign, broom, xaringanthemer, reshape2, DiagrammeR)

i_am("slides/EDUC645_log_regression.rmd")

extra_css <- list(
  ".red"   = list(color = "red"),
  ".blue"  =list(color = "blue"),
  ".green" = list(color = "#8bb174"),
  ".purple" = list(color = "#6A5ACD"),
  ".red-pink" = list(color= "#e64173"),
  ".grey-light" = list(color= "grey70"),
  ".slate" = list(color="#314f4f"),
  ".small" = list("font-size" = "90%"))

write_extra_css(css = extra_css, outfile = "my_custom.css")

# Knitr options
opts_chunk$set(
  comment = "#>",
  fig.align = "center",
  fig.height = 6.75,
  fig.width = 10.5,
  warning = F,
  message = F
)
opts_chunk$set(dev = "svg")
options(device = function(file, width, height) {
  svg(tempfile(), width = width, height = height)
})
options(knitr.table.format = "html")

```

# Roadmap

---
# Count Data

What about examining predictors of outcomes related to a rate or number of events:
* the number of times an event occurs during a given timeframe?
* the number of people in line at the grocery store?

These kinds of questions draw from count data
* Discrete data with non-negative integer values that count a particular outcome according to a defined parameter of time/space

**How does this definition differ from continuous and binomial data?**

---
# Poisson Distribution

* A discrete probability distribution is used to describe the off occurrence of unlikely events in a large number of independent trials

* Poisson is a good approximation to the binomial distribution when the probability is small and the number of trials is large

* It expresses the probability of a number of events occurring in a fixed period of time if these events occur with a known average rate and are independent of the time since the last event
Examine if we want to know "how many of X in what amount of time"

---
# Poisson Distributions

```{r}
lambdas <- c(5, 10, 20, 40)
ggplot(data = data.frame(x = 0:75)) +
    lapply(lambdas, 
           function(l) geom_point(aes(x = x, 
                                      y = dpois(x, lambda = l), 
                                      col = factor(l)))) +
    lapply(lambdas, 
           function(l) stat_function(fun = dnorm, 
                                     args = list(mean = l, sd = sqrt(l)), 
                                    aes(x = x, col = factor(l))))
```

---

# Normal distribution
```{r, echo=F, fig.height=5.5}
# create a sequence -3 to +3 with .05 increments
xseq <- seq(-3, 3, .05)

# generate a Probability Density Function
densities <- dnorm(xseq, 0, 1)

# plot the graph
plot(xseq, densities, col = "blue", xlab = "", ylab = "Density", type = "l", lwd = 2)
# col: changes the color of line
# 'xlab' and 'ylab' are labels for x and y axis respectively
# type: defines the type of plot. 'l' gives a line graph
# lwd: defines line width
```

---
# Poisson Vs. Normal Distribution

|Poisson Distribution |	Normal Distribution|
|----------------------------|---------------------------------|
|Used for count or rate data |	Used for continuous variables |
|Skewed by values of lambda	 | Bell-shaped curve symmetric around the mean.|
|Variance = Mean	| Variance and mean are different parameters; mean, median and mode are equal |
---
# Poisson Distribution: Dispersion


---
# Assumptions

The outcome (Y) is a count (positive integer)
* Ex. the number of people in a subgroup of a population who have a learning disorder
Requires a unit of time:
* E.g., number of accidents per day, number of exposed per year
Population is typically divided into groups, each group independent of the other

Count data can also be expressed as rate data
* the number of times an event occurs within a timeframe can be expressed as:
- raw count (i.e. “In a day, we eat three meals”)
- rate (“We eat at a rate of 0.125 meals per hour”)

---
# Time

Time is used to normalize the count variable that is observed
(number of accidents per day, per year, per week)
Time can be units of time, length of time, or other unit
Number of accidents per mile, students per district

---
# Rate

Rate = # of events/unit of time
Sometimes rescaled so that the number of cases per unit is a whole number
Rate $\neq$ probability
• Rates include unit of time
	- Rates can be >1
• Probabilities do not have a unit
	- Probabilities are always between 0 and 1

---
# Comparing Rates

Suppose we want to compare rate of Y at two different sites (X groups) 
We have to assume that incidents occurred at similar rates throughout the year
Typically organize information about counts and time in a table:

|	      | Count	| Time |
|--------|-------|------|
|Group 1 | N1	  | T1   |
|Group 2 | N2	  | T2   |

---
# Steps to comparing rates:

### 1. Calculate rates in both groups
*	Rate = number of events/unit of time

### 2. Calculate Rate Ratio (RR)
* $RR = \frac{Rate_1}{Rate_2}$

### 3. Conduct test of hypothesis to see is RR $\neq$ 1
*	$H_0: RR = 1$ vs. $H_a: RR \neq 1$
  - $z = \frac{ln(RR)}{\sqrt{(\frac{1}{n_1}+\frac{1}{n_2}}}$
	- Get p-value
* Get CI for RR
*	Draw conclusions
	
---

# [insert examples]

---
class: center, middle 
# Modeling Poisson Distribution
.left[Poisson Regression]

---
# Poisson Regression

Like logistic regression, the underlying mathematics and underlying probability distribution theory are different from OLS regression, but it relies on the same parameters of the GLM

Poisson regression seeks to model counts the number of children, number of colds, number of falls, number of telephone calls

While logistic regression models the log odds of an event
Poisson regression models the (natural) log of the expected count.

Since the log of the expected count is being modeled, there is no problem with negative predicted values, since negative values correspond to expected counts between 0 and 1.

---
Poisson Regression helps us analyze both count data and rate data by allowing us to determine which explanatory variables (X values) have an effect on a given response variable (Y value, the count or a rate). For example, Poisson regression could be applied by a grocery store to better understand and predict the number of people in a line.

---
# Rates Accounting for other factor(s)
Poisson regression allows us to study how rates of an even vary by characteristics of the groups of interest
$\ln(Rate) = \beta_0 + \beta_1X$
Or
$\ln(E[Y]/Time) = \beta_0 + \beta_1X$
- E[Y]: expected number of events
- X: predictor variable
- $\beta_0$: natural log of the rate for the reference group
- $\beta_1$: natural log of the rate ratio between a given group and the reference group
	- Similar to the logistic regression where the coefficient was the natural log of the OR

--- 
$\ln(E[Y]/Time) = \beta_0 + \beta_1X$
- $\ln(E[Y]) - \ln(Time) = \beta_0 + \beta_1X$
-  $\ln(E[Y]) = \beta_0 + \beta_1X + \ln(Time)$
- $\ln(Time)$: *offset variable* takes into account the rate of change over time

---
# Interpreting Coefficients
Poisson regression coefficient represents the *change in response corresponding to a one unit difference in the corresponding predictor.* 

???
Like other regression coefficients, a Poisson regression coefficient represents the change in response corresponding to a one unit difference in the corresponding predictor. Here, the response is expected (natural) logged count.

---
# Beyond the Poisson: Other fish in the sea
* Negative binomial
* Zero-inflated models